{% extends "base.html" %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
        <h2 class="mb-0">Create New Bill</h2>
    </div>
    <div class="card-body">
        <form method="POST" class="needs-validation" novalidate>
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <label for="customer" class="form-label">Select Customer</label>
                    <select class="form-select" id="customer" name="customer_id">
                        <option value="">Walk-in Customer</option>
                        {% for customer in customers %}
                        <option value="{{ customer.id }}">{{ customer.name }} {% if customer.phone %}({{ customer.phone }}){% endif %}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="date" class="form-label">Date</label>
                    <input type="text" class="form-control" id="date" name="date" value="{{ today }}" readonly>
                </div>
            </div>
            <div class="row g-3 mb-4" id="walkin-fields">
                <div class="col-md-6">
                    <label for="customer_name" class="form-label">Customer Name</label>
                    <input type="text" class="form-control" id="customer_name" name="customer_name">
                </div>
                <div class="col-md-6">
                    <label for="mobile_number" class="form-label">Mobile Number</label>
                    <input type="text" class="form-control" id="mobile_number" name="mobile_number">
                </div>
                <div class="col-md-6">
                    <label for="email" class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" name="email">
                </div>
                <div class="col-md-6">
                    <label for="gstin" class="form-label">GSTIN</label>
                    <input type="text" class="form-control" id="gstin" name="gstin">
                </div>
                <div class="col-12">
                    <label for="address" class="form-label">Address</label>
                    <textarea class="form-control" id="address" name="address" rows="2"></textarea>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered" id="items-table">
                    <thead class="table-light">
                        <tr>
                            <th>Item</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <select class="form-select item-select" name="items[]" required>
                                    <option value="">Select Item</option>
                                    {% for item in items %}
                                    <option value="{{ item.id }}" data-price="{{ item.price }}" data-stock="{{ item.quantity }}">
                                        {{ item.name }} ({{ item.price }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input type="number" class="form-control quantity" name="quantities[]" min="1" required>
                            </td>
                            <td>
                                <input type="number" class="form-control price" name="prices[]" readonly>
                            </td>
                            <td>
                                <input type="number" class="form-control total" name="totals[]" readonly>
                            </td>
                            <td>
                                <button type="button" class="btn btn-danger btn-sm remove-row">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <button type="button" class="btn btn-success" id="add-row">
                        <i class="fas fa-plus me-1"></i>Add Item
                    </button>
                </div>
                <div class="col-md-6 text-end">
                    <h4>Total Amount: <span id="grand-total">0.00</span></h4>
                </div>
            </div>

            <div class="form-group">
                <label for="payment_mode">Payment Mode</label>
                <select class="form-control" id="payment_mode" name="payment_mode" required>
                    <option value="cash">Cash</option>
                    <option value="upi">UPI</option>
                    <option value="card">Card</option>
                    <option value="bank_transfer">Bank Transfer</option>
                </select>
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>Create Bill
                </button>
                <a href="{{ url_for('view_bills') }}" class="btn btn-secondary">
                    <i class="fas fa-times me-1"></i>Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Add Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"/>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('items-table');
    const addRowBtn = document.getElementById('add-row');
    const grandTotalSpan = document.getElementById('grand-total');

    // Add new row
    addRowBtn.addEventListener('click', function() {
        const tbody = table.querySelector('tbody');
        const newRow = tbody.rows[0].cloneNode(true);
        
        // Clear values
        newRow.querySelectorAll('input').forEach(input => input.value = '');
        newRow.querySelector('select').selectedIndex = 0;
        
        // Add event listeners
        addRowEventListeners(newRow);
        tbody.appendChild(newRow);
        initSelect2();
    });

    // Add event listeners to initial row
    addRowEventListeners(table.querySelector('tbody tr'));

    // Remove row
    table.addEventListener('click', function(e) {
        if (e.target.closest('.remove-row')) {
            const tbody = table.querySelector('tbody');
            if (tbody.rows.length > 1) {
                e.target.closest('tr').remove();
                updateGrandTotal();
            }
        }
    });

    function addRowEventListeners(row) {
        const itemSelect = row.querySelector('.item-select');
        const quantityInput = row.querySelector('.quantity');
        const priceInput = row.querySelector('.price');
        const totalInput = row.querySelector('.total');

        // Native change event
        itemSelect.addEventListener('change', function() {
            const option = this.options[this.selectedIndex];
            const price = option.getAttribute('data-price') || 0;
            // Remove max restriction
            quantityInput.removeAttribute('max');
            priceInput.value = price;
            // If quantity is already filled, update total
            if (quantityInput.value) {
                totalInput.value = (price * quantityInput.value).toFixed(2);
            } else {
                totalInput.value = '';
            }
            updateGrandTotal();
        });

        // Select2 event
        $(itemSelect).on('select2:select', function (e) {
            const option = this.options[this.selectedIndex];
            const price = option.getAttribute('data-price') || 0;
            // Remove max restriction
            quantityInput.removeAttribute('max');
            priceInput.value = price;
            if (quantityInput.value) {
                totalInput.value = (price * quantityInput.value).toFixed(2);
            } else {
                totalInput.value = '';
            }
            updateGrandTotal();
        });

        quantityInput.addEventListener('input', function() {
            const price = priceInput.value || 0;
            const quantity = this.value || 0;
            totalInput.value = (price * quantity).toFixed(2);
            updateGrandTotal();
        });
    }

    function updateGrandTotal() {
        const totals = Array.from(document.querySelectorAll('.total'))
            .map(input => parseFloat(input.value) || 0);
        const grandTotal = totals.reduce((sum, total) => sum + total, 0);
        grandTotalSpan.textContent = grandTotal.toFixed(2);
    }

    // Form validation
    const form = document.querySelector('form');
    form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
        }
        form.classList.add('was-validated');
    });

    // Show/hide walk-in fields
    const customerSelect = document.getElementById('customer');
    const walkinFields = document.getElementById('walkin-fields');
    function toggleWalkinFields() {
        if (!customerSelect.value) {
            walkinFields.style.display = '';
            walkinFields.querySelectorAll('input').forEach(i => i.required = true);
        } else {
            walkinFields.style.display = 'none';
            walkinFields.querySelectorAll('input').forEach(i => i.required = false);
        }
    }
    customerSelect.addEventListener('change', toggleWalkinFields);
    toggleWalkinFields();

    // Initialize Select2 for all item dropdowns
    function initSelect2() {
        $('.item-select').select2({
            width: '100%',
            placeholder: 'Select Item',
            allowClear: true
        });
    }
    initSelect2();

    // Initialize Bootstrap Datepicker for the date field
    $('#date').datepicker({
        format: 'dd/mm/yyyy',
        autoclose: true,
        todayHighlight: true
    });
});
</script>
{% endblock %} 
{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2 class="mb-4">Create New Bill</h2>
    <form method="POST" id="billForm">
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Customer Information</h5>
                        <div class="mb-3">
                            <label for="customer_id" class="form-label">Select Customer *</label>
                            <select class="form-select" id="customer_id" name="customer_id" required>
                                <option value="">Select a customer</option>
                                {% for customer in customers %}
                                <option value="{{ customer.id }}">{{ customer.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="payment_mode" class="form-label">Payment Mode</label>
                            <select class="form-select" id="payment_mode" name="payment_mode">
                                <option value="Cash">Cash</option>
                                <option value="Card">Card</option>
                                <option value="UPI">UPI</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Bill Information</h5>
                        <div class="mb-3">
                            <label class="form-label">Invoice Number</label>
                            <input type="text" class="form-control" value="{{ invoice_number }}" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <input type="text" class="form-control" value="{{ today }}" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Items</h5>
                <div id="items-container">
                    <div class="row mb-3 item-row">
                        <div class="col-md-4">
                            <select class="form-select item-select" name="items[]" required>
                                <option value="">Select Item</option>
                                {% for item in items %}
                                <option value="{{ item.id }}" data-price="{{ item.price }}" data-stock="{{ item.stock }}">
                                    {{ item.name }} (Stock: {{ item.stock }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control quantity-input" name="quantities[]" min="1" value="1" required>
                        </div>
                        <div class="col-md-2">
                            <input type="text" class="form-control price-display" readonly>
                        </div>
                        <div class="col-md-2">
                            <input type="text" class="form-control subtotal-display" readonly>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-danger remove-item">Remove</button>
                        </div>
                    </div>
                </div>
                <button type="button" class="btn btn-secondary" id="add-item">Add Item</button>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 offset-md-6">
                        <div class="mb-3">
                            <label class="form-label">Subtotal</label>
                            <input type="text" class="form-control" id="subtotal" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Total Tax</label>
                            <input type="text" class="form-control" id="total-tax" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Total Amount</label>
                            <input type="text" class="form-control" id="total-amount" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-end">
            <button type="submit" class="btn btn-primary">Create Bill</button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const itemsContainer = document.getElementById('items-container');
    const addItemButton = document.getElementById('add-item');
    const form = document.getElementById('billForm');

    function updateTotals() {
        let subtotal = 0;
        let totalTax = 0;

        document.querySelectorAll('.item-row').forEach(row => {
            const quantity = parseFloat(row.querySelector('.quantity-input').value) || 0;
            const price = parseFloat(row.querySelector('.price-display').value) || 0;
            const itemSubtotal = quantity * price;
            subtotal += itemSubtotal;
        });

        document.getElementById('subtotal').value = subtotal.toFixed(2);
        document.getElementById('total-tax').value = totalTax.toFixed(2);
        document.getElementById('total-amount').value = (subtotal + totalTax).toFixed(2);
    }

    function updateItemRow(row) {
        const select = row.querySelector('.item-select');
        const quantityInput = row.querySelector('.quantity-input');
        const priceDisplay = row.querySelector('.price-display');
        const subtotalDisplay = row.querySelector('.subtotal-display');
        const option = select.options[select.selectedIndex];

        if (option.value) {
            const price = parseFloat(option.dataset.price);
            const stock = parseInt(option.dataset.stock);
            const quantity = parseInt(quantityInput.value) || 0;

            priceDisplay.value = price.toFixed(2);
            subtotalDisplay.value = (price * quantity).toFixed(2);

            quantityInput.max = stock;
            if (quantity > stock) {
                quantityInput.value = stock;
                subtotalDisplay.value = (price * stock).toFixed(2);
            }
        } else {
            priceDisplay.value = '';
            subtotalDisplay.value = '';
        }

        updateTotals();
    }

    function createItemRow() {
        const row = document.querySelector('.item-row').cloneNode(true);
        row.querySelector('.item-select').value = '';
        row.querySelector('.quantity-input').value = '1';
        row.querySelector('.price-display').value = '';
        row.querySelector('.subtotal-display').value = '';
        return row;
    }

    addItemButton.addEventListener('click', function() {
        const newRow = createItemRow();
        itemsContainer.appendChild(newRow);
        setupRowEventListeners(newRow);
    });

    function setupRowEventListeners(row) {
        const select = row.querySelector('.item-select');
        const quantityInput = row.querySelector('.quantity-input');
        const removeButton = row.querySelector('.remove-item');

        select.addEventListener('change', function() {
            updateItemRow(row);
        });

        quantityInput.addEventListener('input', function() {
            updateItemRow(row);
        });

        removeButton.addEventListener('click', function() {
            if (document.querySelectorAll('.item-row').length > 1) {
                row.remove();
                updateTotals();
            }
        });
    }

    setupRowEventListeners(document.querySelector('.item-row'));

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const customerId = document.getElementById('customer_id').value;
        if (!customerId) {
            alert('Please select a customer');
            return;
        }

        const items = document.querySelectorAll('.item-select');
        let hasItems = false;
        items.forEach(item => {
            if (item.value) hasItems = true;
        });

        if (!hasItems) {
            alert('Please add at least one item');
            return;
        }

        this.submit();
    });
});
</script>
{% endblock %} 
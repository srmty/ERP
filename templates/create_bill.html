{% extends "base.html" %}

{% block content %}
<div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
        <h2 class="mb-0">Create New Bill</h2>
    </div>
    <div class="card-body">
        <form method="POST" class="needs-validation" novalidate>
            <div class="row g-3 mb-4">
                <div class="col-md-6">
                    <label for="customer" class="form-label">Select Customer <span class="text-danger">*</span></label>
                    <select class="form-select" id="customer" name="customer_id" required>
                        <option value="">Select Customer</option>
                        {% for customer in customers %}
                        <option value="{{ customer.id }}">{{ customer.name }} {% if customer.phone %}({{ customer.phone }}){% endif %}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label for="date" class="form-label">Date</label>
                    <input type="text" class="form-control" id="date" name="date" value="{{ today }}" readonly>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-bordered" id="items-table">
                    <thead class="table-light">
                        <tr>
                            <th>Item</th>
                            <th>Quantity</th>
                            <th>Price</th>
                            <th>Total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <select class="form-select item-select" name="items[]" required>
                                    <option value="">Select Item</option>
                                    {% for item in items %}
                                    <option value="{{ item.id }}" data-price="{{ item.price }}" data-stock="{{ item.stock }}">
                                        {{ item.name }} ({{ item.price }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </td>
                            <td>
                                <input type="number" class="form-control quantity" name="quantities[]" min="1" required>
                            </td>
                            <td>
                                <input type="number" class="form-control price" name="prices[]" readonly>
                            </td>
                            <td>
                                <input type="number" class="form-control total" name="totals[]" readonly>
                            </td>
                            <td>
                                <button type="button" class="btn btn-warning btn-sm clear-row me-1" title="Clear Row">
                                    <i class="fas fa-eraser"></i>
                                </button>
                                <button type="button" class="btn btn-danger btn-sm remove-row">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="row g-3">
                <div class="col-md-6">
                    <button type="button" class="btn btn-success" id="add-row">
                        <i class="fas fa-plus me-1"></i>Add Item
                    </button>
                </div>
                <div class="col-md-6 text-end">
                    <h4>Total Amount: <span id="grand-total">0.00</span></h4>
                </div>
            </div>

            <div class="form-group">
                <label for="payment_mode">Payment Mode</label>
                <select class="form-control" id="payment_mode" name="payment_mode" required>
                    <option value="cash">Cash</option>
                    <option value="upi">UPI</option>
                    <option value="card">Card</option>
                    <option value="bank_transfer">Bank Transfer</option>
                </select>
            </div>

            <div class="mt-4">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>Create Bill
                </button>
                <a href="{{ url_for('view_bills') }}" class="btn btn-secondary">
                    <i class="fas fa-times me-1"></i>Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Add Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/css/bootstrap-datepicker.min.css"/>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.9.0/js/bootstrap-datepicker.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const table = document.getElementById('items-table');
    const addRowBtn = document.getElementById('add-row');
    const grandTotalSpan = document.getElementById('grand-total');

    // Initialize Select2 for customer dropdown
    $('#customer').select2({
        placeholder: 'Select Customer',
        allowClear: true
    });

    // Add new row
    addRowBtn.addEventListener('click', function() {
        const tbody = table.querySelector('tbody');
        const newRow = tbody.rows[0].cloneNode(true);
        
        // Clear values
        newRow.querySelectorAll('input').forEach(input => input.value = '');
        newRow.querySelector('select').selectedIndex = 0;
        
        // Add event listeners
        addRowEventListeners(newRow);
        tbody.appendChild(newRow);
        initSelect2();
    });

    // Add event listeners to initial row
    addRowEventListeners(table.querySelector('tbody tr'));

    // Remove row
    table.addEventListener('click', function(e) {
        if (e.target.closest('.remove-row')) {
            const tbody = table.querySelector('tbody');
            if (tbody.rows.length > 1) {
                e.target.closest('tr').remove();
                updateGrandTotal();
            }
        }
        // Clear row
        if (e.target.closest('.clear-row')) {
            const row = e.target.closest('tr');
            row.querySelector('.item-select').selectedIndex = 0;
            $(row.querySelector('.item-select')).val('').trigger('change');
            row.querySelector('.quantity').value = '';
            row.querySelector('.price').value = '';
            row.querySelector('.total').value = '';
            updateGrandTotal();
        }
    });

    function addRowEventListeners(row) {
        const itemSelect = row.querySelector('.item-select');
        const quantityInput = row.querySelector('.quantity');
        const priceInput = row.querySelector('.price');
        const totalInput = row.querySelector('.total');

        // Native change event
        itemSelect.addEventListener('change', function() {
            const option = this.options[this.selectedIndex];
            const price = option.getAttribute('data-price') || 0;
            const stock = option.getAttribute('data-stock') || 0;
            quantityInput.setAttribute('max', stock);
            priceInput.value = price;
            // If quantity is already filled, update total
            if (quantityInput.value) {
                const quantity = Math.min(parseInt(quantityInput.value), parseInt(stock));
                quantityInput.value = quantity;
                totalInput.value = (price * quantity).toFixed(2);
            } else {
                totalInput.value = '';
            }
            updateGrandTotal();
        });

        quantityInput.addEventListener('input', function() {
            const price = parseFloat(priceInput.value) || 0;
            const quantity = parseInt(this.value) || 0;
            const stock = parseInt(itemSelect.options[itemSelect.selectedIndex].getAttribute('data-stock')) || 0;
            
            if (quantity > stock) {
                this.value = stock;
                flash('Quantity exceeds available stock', 'warning');
            }
            
            totalInput.value = (price * this.value).toFixed(2);
            updateGrandTotal();
        });
    }

    function updateGrandTotal() {
        let total = 0;
        table.querySelectorAll('.total').forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        grandTotalSpan.textContent = total.toFixed(2);
    }

    function initSelect2() {
        $('.item-select').select2({
            placeholder: 'Select Item',
            allowClear: true
        });
    }

    // Initialize Select2 for initial row
    initSelect2();
});
</script>
{% endblock %} 
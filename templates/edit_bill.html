{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2>Edit Bill</h2>
    <form method="POST" id="billForm">
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Customer Details</h5>
                        <div class="mb-3">
                            <label for="customer_name" class="form-label">Customer Name</label>
                            <input type="text" class="form-control" id="customer_name" name="customer_name" value="{{ bill.customer_name }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="mobile_number" class="form-label">Mobile Number</label>
                            <input type="text" class="form-control" id="mobile_number" name="mobile_number" value="{{ bill.mobile_number }}">
                        </div>
                        <div class="mb-3">
                            <label for="email" class="form-label">Email (Optional)</label>
                            <input type="email" class="form-control" id="email" name="email" value="{{ bill.email }}">
                        </div>
                        <div class="mb-3">
                            <label for="address" class="form-label">Address</label>
                            <textarea class="form-control" id="address" name="address" rows="2">{{ bill.address }}</textarea>
                        </div>
                        <div class="mb-3">
                            <label for="gstin" class="form-label">GSTIN</label>
                            <input type="text" class="form-control" id="gstin" name="gstin" value="{{ bill.gstin }}">
                        </div>
                        <div class="mb-3">
                            <label for="payment_mode" class="form-label">Payment Mode</label>
                            <select class="form-select" id="payment_mode" name="payment_mode">
                                <option value="cash" {% if bill.payment_mode == 'cash' %}selected{% endif %}>Cash</option>
                                <option value="card" {% if bill.payment_mode == 'card' %}selected{% endif %}>Card</option>
                                <option value="upi" {% if bill.payment_mode == 'upi' %}selected{% endif %}>UPI</option>
                                <option value="bank_transfer" {% if bill.payment_mode == 'bank_transfer' %}selected{% endif %}>Bank Transfer</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Items</h5>
                        <div id="items-container">
                            {% for item in bill.items %}
                            <div class="item-row mb-3">
                                <div class="row">
                                    <div class="col-md-4">
                                        <select class="form-select item-select" name="items[]" required>
                                            <option value="">Select Item</option>
                                            {% for available_item in items %}
                                            <option value="{{ available_item.id }}" 
                                                    data-price="{{ available_item.price }}"
                                                    data-tax="{{ available_item.tax_rate }}"
                                                    data-stock="{{ available_item.stock }}"
                                                    {% if item.item_id == available_item.id %}selected{% endif %}>
                                                {{ available_item.name }} (Stock: {{ available_item.stock }})
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" class="form-control quantity" name="quantities[]" placeholder="Qty" min="1" value="{{ item.quantity }}" required>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" class="form-control price" name="prices[]" placeholder="Price" step="0.01" value="{{ item.price }}" required>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" class="form-control tax-rate" name="tax_rates[]" placeholder="Tax %" step="0.01" value="{{ item.tax_rate }}" required>
                                    </div>
                                    <div class="col-md-2">
                                        <button type="button" class="btn btn-danger remove-item">Remove</button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="btn btn-secondary" id="add-item">Add Item</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <button type="submit" class="btn btn-primary">Update Bill</button>
                <a href="{{ url_for('view_bills') }}" class="btn btn-secondary">Cancel</a>
            </div>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const itemsContainer = document.getElementById('items-container');
    const addItemButton = document.getElementById('add-item');
    
    // Function to create a new item row
    function createItemRow() {
        const template = itemsContainer.querySelector('.item-row').cloneNode(true);
        template.querySelector('.item-select').value = '';
        template.querySelector('.quantity').value = '';
        template.querySelector('.price').value = '';
        template.querySelector('.tax-rate').value = '';
        return template;
    }
    
    // Add new item row
    addItemButton.addEventListener('click', function() {
        itemsContainer.appendChild(createItemRow());
    });
    
    // Remove item row
    itemsContainer.addEventListener('click', function(e) {
        if (e.target.classList.contains('remove-item')) {
            if (itemsContainer.querySelectorAll('.item-row').length > 1) {
                e.target.closest('.item-row').remove();
            }
        }
    });
    
    // Update price and tax rate when item is selected
    itemsContainer.addEventListener('change', function(e) {
        if (e.target.classList.contains('item-select')) {
            const option = e.target.options[e.target.selectedIndex];
            const row = e.target.closest('.item-row');
            const priceInput = row.querySelector('.price');
            const taxRateInput = row.querySelector('.tax-rate');
            
            if (option.value) {
                priceInput.value = option.dataset.price;
                taxRateInput.value = option.dataset.tax || 0;
            }
        }
    });
});
</script>
{% endblock %} 